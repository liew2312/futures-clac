<!doctype html>
<html lang="th">
<head>
<link rel="icon" href="icons/icon-192.png" type="image/png" />
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b1020">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Futures Calculator – Fixed PnL</title>
<style>
  :root{--bg:#0b1020;--muted:#9aa4b2;--text:#e5e7eb;--border:rgba(148,163,184,.25);--green:#10b981;--red:#ef4444;--brand:#22d3ee;}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:linear-gradient(180deg,var(--bg),#060a1a);color:var(--text)}
  .wrap{max-width:860px;margin:auto;padding:16px}
  header{display:flex;align-items:center;gap:10px;margin:6px 0 14px}
  .logo{width:36px;height:36px;border-radius:12px;background:radial-gradient(35% 35% at 30% 30%,var(--brand),#60a5fa);box-shadow:0 10px 30px rgba(34,211,238,.35)}
  h1{font-size:1.2rem;margin:0}
  .tabs{display:flex;background:#0f172a;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .tab{flex:1;text-align:center;padding:10px;font-weight:600;cursor:pointer;color:var(--muted)}
  .tab.active{background:#13203a;color:#67e8f9}
  .card{background:rgba(17,24,39,.75);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:16px;padding:14px;margin-top:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:680px){.row{grid-template-columns:1fr}}
  label{display:block;font-size:.86rem;color:var(--muted);margin:6px 2px}
  input[type=number]{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0b1224;color:var(--text)}
  input[type=range]{width:100%}
  .seg{display:flex;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-bottom:8px}
  .seg button{flex:1;padding:10px 12px;border:0;background:transparent;color:var(--muted);font-weight:700}
  .seg button.active{background:#1f2937;color:#e5e7eb}
  .result{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  .tile{background:#0b1224;border:1px dashed var(--border);border-radius:14px;padding:10px}
  .tile h3{margin:0 0 4px;font-size:.95rem}
  .pos{color:var(--green)} .neg{color:var(--red)} .muted{color:#9aa4b2}
  .btn{appearance:none;border:1px solid var(--border);background:#13203a;color:#67e8f9;border-radius:12px;padding:10px 12px;font-weight:700}
  .divider{height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:10px 0}
  .note{font-size:.74rem;color:#9aa4b2}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo"></div>
    <div>
      <h1>Futures คำนวณ PnL / Target / Max / Liquidation</h1>
      <div class="muted" style="font-size:.8rem">เวอร์ชันแก้ PnL — รองรับ Qty (เหรียญ) หรือ Position (USDT)</div>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="pnl">PnL</div>
    <div class="tab" data-tab="target">Target Price</div>
    <div class="tab" data-tab="max">Max Open</div>
    <div class="tab" data-tab="liq">Liquidation</div>
  </div>

  <!-- PnL TAB -->
  <section id="pnl" class="card">
    <div class="seg">
      <button id="longBtn" class="active">Long</button>
      <button id="shortBtn">Short</button>
    </div>
    <label>Leverage: <span id="levShow">20x</span></label>
    <input id="lev" type="range" min="1" max="125" step="1" value="20">

    <div class="row"><div><label>Symbol (เช่น BTCUSDT)</label><input id="symbol1" type="text" placeholder="BTCUSDT"></div>
      <div><label>Entry Price</label><input id="entry1" type="number" step="0.0001" value="23.500"></div>
      <div><label>Exit Price</label><input id="exit1" type="number" step="0.0001" value="24.000"></div>
      <div><label>Quantity (เหรียญ)</label><input id="qty1" type="number" step="0.000001" value="10"></div>
      <div><label>หรือ Position (USDT)</label><input id="posUSDT1" type="number" step="0.01" placeholder="เช่น 1000"></div>
    </div>

    <div class="divider"></div>
    <div class="result">
      <div class="tile"><h3>Position Value</h3><div id="pos1" class="muted">-</div></div>
      <div class="tile"><h3>Initial Margin</h3><div id="im1" class="muted">-</div></div>
      <div class="tile"><h3>PnL</h3><div id="pnl1" class="muted">-</div></div>
      <div class="tile"><h3>ROI</h3><div id="roi1" class="muted">-</div></div>
      <div class="tile"><h3>Liquidation (≈)</h3><div id="liq1" class="muted">-</div></div>
    </div>

    <div class="divider"></div>
    <button class="btn" id="saveImgBtn">บันทึกผลลัพธ์เป็นภาพ (PNG)</button>
    <canvas id="shareCanvas" width="1200" height="630" style="display:none"></canvas>
  </section>

  <!-- TARGET TAB -->
  <section id="target" class="card" style="display:none">
    <div class="seg"><button id="longBtn2" class="active">Long</button><button id="shortBtn2">Short</button></div>
    <div class="row">
      <div><label>Entry Price</label><input id="entry2" type="number" step="0.0001" value="23.500"></div>
      <div><label>Quantity (เหรียญ)</label><input id="qty2" type="number" step="0.000001" value="10"></div>
      <div><label>Leverage</label><input id="lev2" type="number" step="1" value="20"></div>
      <div><label>เป้า ROI %</label><input id="roiTarget" type="number" step="0.01" value="25"></div>
      <div><label>หรือ กำไร (USDT)</label><input id="pnlTarget" type="number" step="0.01" value=""></div>
    </div>
    <div class="divider"></div>
    <div class="result">
      <div class="tile"><h3>Initial Margin</h3><div id="im2" class="muted">-</div></div>
      <div class="tile"><h3>Target Exit Price</h3><div id="exit2" class="muted">-</div></div>
    </div>
  </section>

  <!-- MAX OPEN TAB -->
  <section id="max" class="card" style="display:none">
    <label>Available Balance (USDT)</label><input id="bal3" type="number" step="0.01" value="1000">
    <label style="margin-top:10px">Leverage: <span id="levShow3">20x</span></label><input id="lev3" type="range" min="1" max="125" step="1" value="20">
    <div class="row"><div><label>Entry Price</label><input id="entry3" type="number" step="0.0001" value="23.500"></div></div>
    <div class="divider"></div>
    <div class="result">
      <div class="tile"><h3>Maximum Position Value</h3><div id="maxPos" class="muted">-</div></div>
      <div class="tile"><h3>Maximum Quantity</h3><div id="maxQty" class="muted">-</div></div>
    </div>
    <div class="muted" style="font-size:.8rem">* ไม่รวมค่าธรรมเนียม/maintenance margin — ควรเผื่อไว้</div>
  </section>

  <!-- LIQ TAB -->
  <section id="liq" class="card" style="display:none">
    <div class="seg"><button id="longBtn3" class="active">Long</button><button id="shortBtn3">Short</button></div>
    <div class="row">
      <div><label>Entry Price</label><input id="entry4" type="number" step="0.0001" value="23.500"></div>
      <div><label>Leverage (x)</label><input id="lev4" type="number" step="1" value="20"></div>
      <div><label>Maintenance Margin Rate (MMR %)</label><input id="mmr4" type="number" step="0.01" value="0.5"></div>
    </div>
    <div class="divider"></div>
    <div class="result">
      <div class="tile"><h3>Liquidation (ประมาณการ Isolated)</h3><div id="liq4" class="muted">-</div></div>
      <div class="tile"><h3>ระยะจาก Entry</h3><div id="dist4" class="muted">-</div></div>
    </div>
  </section>
</div>

<script>
const fmt=(n,d=2)=>isFinite(n)?Number(n).toLocaleString(undefined,{maximumFractionDigits:d,minimumFractionDigits:d}):'-';
function switchTab(tab){document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));document.querySelectorAll('section').forEach(s=>s.style.display='none');document.getElementById(tab).style.display='block';}
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>switchTab(t.dataset.tab)));
function tgl(a,b){document.getElementById(a).classList.add('active');document.getElementById(b).classList.remove('active');}

// ===== PNL (USDⓈ-M) =====
let side1=1;
document.getElementById('longBtn').onclick=()=>{side1=1;tgl('longBtn','shortBtn');calcPnL();};
document.getElementById('shortBtn').onclick=()=>{side1=-1;tgl('shortBtn','longBtn');calcPnL();};
const lev=document.getElementById('lev'),levShow=document.getElementById('levShow');lev.oninput=()=>{levShow.textContent=lev.value+'x';calcPnL();};
['entry1','exit1','qty1','posUSDT1'].forEach(id=>document.getElementById(id).addEventListener('input',calcPnL));

function getMMR(){const v=parseFloat(document.getElementById('mmr4').value);return isNaN(v)?0.005:Math.max(0,v)/100;}

function calcPnL(){
  const entry = parseFloat(document.getElementById('entry1').value)||0;
  const exit  = parseFloat(document.getElementById('exit1').value)||0;
  const qtyIn = parseFloat(document.getElementById('qty1').value)||0;      // จำนวนเหรียญ (ถ้าผู้ใช้กรอก)
  const posUS = parseFloat(document.getElementById('posUSDT1').value)||0;  // Position เป็น USDT (ถ้าผู้ใช้กรอก)

  // ถ้ากรอก Position(USDT) ให้แปลงเป็นจำนวนเหรียญอัตโนมัติ
  const qty   = (posUS>0 && entry>0) ? (posUS/entry) : qtyIn;

  const L     = Math.max(1, parseInt(lev.value)||1);
  const position = entry * qty;      // มูลค่าสัญญา (USDT)
  const im    = position / L;        // Initial Margin

  // PnL: USDⓈ-M
  let pnl = (exit - entry) * qty;    // Long
  if (side1 === -1) pnl = (entry - exit) * qty; // Short

  const roi   = im>0 ? (pnl/im)*100 : NaN;

  document.getElementById('pos1').textContent = fmt(position,2)+' USDT';
  document.getElementById('im1').textContent  = fmt(im,2)+' USDT';
  document.getElementById('pnl1').textContent = (pnl>=0?'+':'')+fmt(pnl,2)+' USDT';
  document.getElementById('pnl1').className   = 'muted ' + (pnl>=0?'pos':'neg');
  document.getElementById('roi1').textContent = isFinite(roi)?((roi>=0?'+':'')+fmt(roi,2)+' %'):'-';
  document.getElementById('roi1').className   = 'muted ' + (roi>=0?'pos':'neg');

  // Liquidation (ประมาณ): Long ≈ E*(1 - 1/L + MMR), Short ≈ E*(1 + 1/L - MMR)
  const mmr = getMMR();
  let liq = NaN;
  if(entry>0 && L>0){ liq = side1===1 ? entry*(1 - 1/L + mmr) : entry*(1 + 1/L - mmr); }
  document.getElementById('liq1').textContent = isFinite(liq)? fmt(liq,6) : '-';
}
calcPnL();

// ===== TARGET =====
let side2=1;
document.getElementById('longBtn2').onclick=()=>{side2=1;tgl('longBtn2','shortBtn2');calcTarget();};
document.getElementById('shortBtn2').onclick=()=>{side2=-1;tgl('shortBtn2','longBtn2');calcTarget();};
['entry2','qty2','lev2','roiTarget','pnlTarget'].forEach(id=>document.getElementById(id).addEventListener('input',calcTarget));
function calcTarget(){
  const entry=parseFloat(document.getElementById('entry2').value)||0;
  const qty=parseFloat(document.getElementById('qty2').value)||0;
  const L=Math.max(1, parseInt(document.getElementById('lev2').value)||1);
  const roiTarget=parseFloat(document.getElementById('roiTarget').value);
  const pnlTarget=parseFloat(document.getElementById('pnlTarget').value);
  const pos = entry*qty; const im = pos/L;
  let pnl = !isNaN(pnlTarget)? pnlTarget : (!isNaN(roiTarget)? (roiTarget/100)*im : 0);
  let exit = entry + (side2===1 ? (pnl/qty) : -(pnl/qty));
  document.getElementById('im2').textContent = fmt(im,2)+' USDT';
  document.getElementById('exit2').textContent = (qty>0? fmt(exit,6) : '-');
}
calcTarget();

// ===== MAX OPEN =====
const lev3=document.getElementById('lev3'),levShow3=document.getElementById('levShow3');
function calcMax(){
  const bal=parseFloat(document.getElementById('bal3').value)||0;
  const entry=parseFloat(document.getElementById('entry3').value)||0;
  const L=Math.max(1, parseInt(lev3.value)||1);
  const maxPos = bal * L;
  const maxQty = entry>0 ? maxPos / entry : NaN;
  document.getElementById('maxPos').textContent = fmt(maxPos,2)+' USDT';
  document.getElementById('maxQty').textContent = isFinite(maxQty)? fmt(maxQty,6) : '-';
  levShow3.textContent = L+'x';
}
['bal3','entry3'].forEach(id=>document.getElementById(id).addEventListener('input',calcMax));
lev3.oninput=calcMax; calcMax();

// ===== LIQ =====
let side3=1;
document.getElementById('longBtn3').onclick=()=>{side3=1;tgl('longBtn3','shortBtn3');calcLiq();};
document.getElementById('shortBtn3').onclick=()=>{side3=-1;tgl('shortBtn3','longBtn3');calcLiq();};
['entry4','lev4','mmr4'].forEach(id=>document.getElementById(id).addEventListener('input',()=>{calcLiq(); calcPnL();}));
function calcLiq(){
  const entry=parseFloat(document.getElementById('entry4').value)||0;
  const L=Math.max(1, parseInt(document.getElementById('lev4').value)||1);
  const mmr=(parseFloat(document.getElementById('mmr4').value)||0)/100;
  let liq = NaN;
  if(entry>0 && L>0){ liq = side3===1 ? entry*(1 - 1/L + mmr) : entry*(1 + 1/L - mmr); }
  const dist = isFinite(liq) && entry>0 ? Math.abs((liq-entry)/entry)*100 : NaN;
  document.getElementById('liq4').textContent = isFinite(liq)? fmt(liq,6) : '-';
  document.getElementById('dist4').textContent = isFinite(dist)? fmt(dist,2)+' %' : '-';
}
calcLiq();

// ===== Save as Image =====
const saveBtn=document.getElementById('saveImgBtn'); const canvas=document.getElementById('shareCanvas');
function saveAsImage(){
  const symbol=document.getElementById('symbol1').value || '-';
  const entry=document.getElementById('entry1').value || '-';
  const exit =document.getElementById('exit1').value  || '-';
  const qty  =document.getElementById('qty1').value   || '-';
  const posUS=document.getElementById('posUSDT1').value||'';
  const levv =document.getElementById('lev').value    || '-';
  const pos  =document.getElementById('pos1').textContent || '-';
  const im   =document.getElementById('im1').textContent  || '-';
  const pnl  =document.getElementById('pnl1').textContent || '-';
  const roi  =document.getElementById('roi1').textContent || '-';
  const liq  =document.getElementById('liq1').textContent || '-';
  const side =(document.getElementById('longBtn').classList.contains('active')?'Long':'Short');
  const ctx=canvas.getContext('2d'); const w=canvas.width,h=canvas.height;
  const grad=ctx.createLinearGradient(0,0,0,h); grad.addColorStop(0,'#0b1020'); grad.addColorStop(1,'#061024');
  ctx.fillStyle=grad; ctx.fillRect(0,0,w,h);
  ctx.fillStyle='rgba(34,211,238,0.15)'; ctx.beginPath(); ctx.arc(w-180,140,120,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='rgba(52,211,153,0.10)'; ctx.beginPath(); ctx.arc(180,h-140,140,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#e5e7eb'; ctx.font='bold 44px system-ui, Segoe UI, Roboto';
  ctx.fillText('คำนวน Trade Futures – สรุปผลลัพธ์', 40, 80);
  ctx.font='600 28px system-ui, Segoe UI, Roboto'; ctx.fillStyle='#9aa4b2';
  const qtyShow = posUS ? `${posUS} USDT (~${qty}u)` : `${qty}u`;
  ctx.fillStyle='#22d3ee'; ctx.fillText(`Symbol: ${symbol}`, 40, 160); ctx.fillStyle='#9aa4b2';
  ctx.fillText(`โหมด: ${side}  •  Leverage: ${levv}x`, 40, 120);
  const box=(x,y,title,value,color='#e5e7eb')=>{
    ctx.fillStyle='rgba(148,163,184,0.15)'; ctx.strokeStyle='rgba(148,163,184,0.35)'; ctx.lineWidth=2;
    ctx.beginPath(); if(ctx.roundRect){ctx.roundRect(x,y,500,120,16);} else {ctx.rect(x,y,500,120);} ctx.fill(); ctx.stroke();
    ctx.fillStyle='#94a3b8'; ctx.font='600 24px system-ui'; ctx.fillText(title,x+20,y+40);
    ctx.fillStyle=color; ctx.font='bold 40px system-ui'; ctx.fillText(value,x+20,y+88);
  };
  const pnlColor=pnl.trim().startsWith('+')?'#10b981':'#ef4444';
  const roiColor=roi.trim().startsWith('+')?'#10b981':'#ef4444';
  box(40,200,'Entry / Exit / Qty', `${entry} / ${exit}  •  ${qtyShow}`);
  box(40,340,'Position Value', pos);
  box(40,480,'Initial Margin', im);
  box(620,200,'PnL', pnl, pnlColor);
  box(620,340,'ROI', roi, roiColor);
  box(620,480,'Liquidation (≈)', liq, '#fbbf24');
  ctx.fillStyle='#94a3b8'; ctx.font='600 20px system-ui';
  ctx.fillText('คำนวน Trade Futures • เวอร์ชันแก้ PnL (ไฟล์เดียว)', 40, h-30);
  const link=document.createElement('a'); link.download=`futures-summary-${Date.now()}.png`; link.href=canvas.toDataURL('image/png'); link.click();
}
if(saveBtn) saveBtn.addEventListener('click', saveAsImage);
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js').catch(console.error);
  });
}
</script>
</body>

</html>
